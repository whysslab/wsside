<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ProBIDE API æ ¼å¼æµ‹è¯•</title>
  <style>
    body { 
      background: #181c20; 
      color: #e0e0e0; 
      font-family: system-ui, sans-serif; 
      margin: 0; 
      padding: 20px; 
    }
    .test-section {
      background: #24282f;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #3c424d;
    }
    .test-title {
      color: #89b4fa;
      font-size: 18px;
      margin-bottom: 16px;
    }
    button {
      background: #89b4fa;
      color: #181d21;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover { background: #a6c8ff; }
    .code-block {
      background: #1a1d21;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      margin: 8px 0;
      white-space: pre-wrap;
    }
    .result {
      background: #1a1d21;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      min-height: 100px;
      white-space: pre-wrap;
    }
    .status-success { color: #3ecf8e; }
    .status-error { color: #ff6b6b; }
    .status-info { color: #89b4fa; }
  </style>
</head>
<body>
  <h1>ğŸ”§ ProBIDE API æ ¼å¼æµ‹è¯•</h1>
  
  <div class="test-section">
    <div class="test-title">ğŸ“‹ API æ ¼å¼æ›´æ–°</div>
    <p>å·²å°† ProBIDE çš„é¢˜ç›®è½¬æ¢ API è¯·æ±‚æ ¼å¼æ›´æ–°ä¸ºä¸ IDE ai-agent ä¸€è‡´ï¼š</p>
    
    <h4>æ›´æ–°å‰ï¼š</h4>
    <div class="code-block">
// æ—§æ ¼å¼
fetch('/api/ai-agent', {
  method: 'POST',
  body: JSON.stringify({
    message: "...",
    context: 'problem_conversion'
  })
});
    </div>
    
    <h4>æ›´æ–°åï¼š</h4>
    <div class="code-block">
// æ–°æ ¼å¼ï¼ˆå‚è€ƒ IDE ai-agentï¼‰
const apiBase = window.IDE_CONFIG ? 
  window.IDE_CONFIG.getApiConfig().AI_AGENT : 
  'https://api.ide.whyss.tech/api/ai';

// 1. æ£€æŸ¥å¥åº·çŠ¶æ€
await fetch(`${apiBase}/health`, {
  method: 'GET',
  mode: 'cors'
});

// 2. å‘é€èŠå¤©è¯·æ±‚
await fetch(`${apiBase}/chat`, {
  method: 'POST',
  body: JSON.stringify({
    message: "...",
    session_id: sessionId
  }),
  mode: 'cors'
});

// 3. å¤„ç†æµå¼å“åº”
const reader = response.body.getReader();
// ... æµå¼å¤„ç†é€»è¾‘
    </div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ§ª æµ‹è¯•åŠŸèƒ½</div>
    <p>æµ‹è¯•é¢˜ç›®å†…å®¹ï¼ˆå¯ä»¥ä¿®æ”¹ï¼‰ï¼š</p>
    <textarea id="testContent" style="width: 100%; height: 100px; background: #3c424d; color: #e0e0e0; border: 1px solid #505664; border-radius: 4px; padding: 8px; font-family: inherit;">
é¢˜ç›®ï¼šä¸¤æ•°ä¹‹å’Œ
ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªæ•´æ•°ç›®æ ‡å€¼ targetï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡ºå’Œä¸ºç›®æ ‡å€¼ target çš„é‚£ä¸¤ä¸ªæ•´æ•°ï¼Œå¹¶è¿”å›å®ƒä»¬çš„æ•°ç»„ä¸‹æ ‡ã€‚

è¾“å…¥ï¼šnums = [2,7,11,15], target = 9
è¾“å‡ºï¼š[0,1]
è§£é‡Šï¼šå› ä¸º nums[0] + nums[1] == 9 ï¼Œè¿”å› [0, 1]ã€‚
    </textarea>
    
    <div style="margin-top: 12px;">
      <button onclick="testConversion()">æµ‹è¯• AI è½¬æ¢</button>
      <button onclick="testHealthCheck()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
      <button onclick="clearResult()">æ¸…ç©ºç»“æœ</button>
    </div>
    
    <div id="result" class="result"></div>
  </div>

  <div class="test-section">
    <div class="test-title">ğŸ” è°ƒè¯•ä¿¡æ¯</div>
    <p>å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š</p>
    <ul>
      <li>AI æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</li>
      <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
      <li>CORS è®¾ç½®æ˜¯å¦æ­£ç¡®</li>
      <li>API ç«¯ç‚¹æ˜¯å¦å¯è®¿é—®</li>
    </ul>
    
    <button onclick="window.open('./index.html', '_blank')">æ‰“å¼€ ProBIDE æµ‹è¯•</button>
  </div>

  <script>
    // å¤åˆ¶ ProBIDE ä¸­çš„ç›¸å…³å‡½æ•°è¿›è¡Œæµ‹è¯•
    function isMarkdownFormat(content) {
      const markdownIndicators = [
        /^#{1,6}\s+/m,           // æ ‡é¢˜
        /\*\*.*?\*\*/,           // ç²—ä½“
        /\*.*?\*/,               // æ–œä½“
        /`.*?`/,                 // è¡Œå†…ä»£ç 
        /```[\s\S]*?```/,        // ä»£ç å—
        /^\* /m,                 // æ— åºåˆ—è¡¨
        /^\d+\. /m,              // æœ‰åºåˆ—è¡¨
        /^\> /m                  // å¼•ç”¨
      ];
      
      return markdownIndicators.some(pattern => pattern.test(content));
    }

    async function convertProblemToMarkdown(content) {
      try {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ Markdown æ ¼å¼
        if (isMarkdownFormat(content)) {
          return content;
        }
        
        // è·å– API åŸºç¡€è·¯å¾„ï¼ˆå‚è€ƒ IDE ai-agent æ ¼å¼ï¼‰
        const apiBase = window.IDE_CONFIG ? window.IDE_CONFIG.getApiConfig().AI_AGENT : 'https://api.ide.whyss.tech/api/ai';
        const sessionId = 'probide_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨
        const healthResponse = await fetch(`${apiBase}/health`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          mode: 'cors'
        });
        
        if (!healthResponse.ok) {
          throw new Error('AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
        }
        
        // è°ƒç”¨ AI API è½¬æ¢ä¸º Markdownï¼ˆå‚è€ƒ IDE ai-agent æ ¼å¼ï¼‰
        const response = await fetch(`${apiBase}/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: `è¯·å°†ä»¥ä¸‹é¢˜ç›®å†…å®¹è½¬æ¢ä¸ºæ ‡å‡†çš„ Markdown æ ¼å¼ï¼Œåªè¿”å› Markdown å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæˆ–é¢å¤–æ–‡å­—ï¼š\n\n${content}`,
            session_id: sessionId
          }),
          mode: 'cors'
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${errorText}`);
        }
        
        // å¤„ç†æµå¼å“åº”ï¼ˆå‚è€ƒ IDE ai-agent çš„å¤„ç†æ–¹å¼ï¼‰
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                if (data.content) {
                  fullContent += data.content;
                } else if (data.done) {
                  return fullContent || content;
                } else if (data.error) {
                  throw new Error(data.error);
                }
              } catch (e) {
                console.warn('è§£ææµæ•°æ®å¤±è´¥:', e);
              }
            }
          }
        }
        
        return fullContent || content;
        
      } catch (error) {
        console.error('AI è½¬æ¢å¤±è´¥:', error);
        // é™çº§å¤„ç†ï¼šè¿”å›åŸå§‹å†…å®¹
        return content;
      }
    }

    async function testConversion() {
      const content = document.getElementById('testContent').value;
      const result = document.getElementById('result');
      
      result.innerHTML = '<span class="status-info">æ­£åœ¨æµ‹è¯• AI è½¬æ¢...</span>';
      
      try {
        const converted = await convertProblemToMarkdown(content);
        result.innerHTML = `<span class="status-success">âœ… è½¬æ¢æˆåŠŸ</span>\n\nåŸå§‹å†…å®¹ï¼š\n${content}\n\nè½¬æ¢ç»“æœï¼š\n${converted}`;
      } catch (error) {
        result.innerHTML = `<span class="status-error">âŒ è½¬æ¢å¤±è´¥</span>\n\né”™è¯¯ä¿¡æ¯ï¼š\n${error.message}`;
      }
    }

    async function testHealthCheck() {
      const result = document.getElementById('result');
      
      result.innerHTML = '<span class="status-info">æ­£åœ¨æ£€æŸ¥ AI æœåŠ¡å¥åº·çŠ¶æ€...</span>';
      
      try {
        const apiBase = window.IDE_CONFIG ? window.IDE_CONFIG.getApiConfig().AI_AGENT : 'https://api.ide.whyss.tech/api/ai';
        
        const response = await fetch(`${apiBase}/health`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          mode: 'cors'
        });
        
        if (response.ok) {
          const data = await response.text();
          result.innerHTML = `<span class="status-success">âœ… AI æœåŠ¡æ­£å¸¸</span>\n\nAPI åŸºç¡€è·¯å¾„ï¼š${apiBase}\nå“åº”ï¼š${data}`;
        } else {
          result.innerHTML = `<span class="status-error">âŒ AI æœåŠ¡å¼‚å¸¸</span>\n\nçŠ¶æ€ç ï¼š${response.status}\nçŠ¶æ€æ–‡æœ¬ï¼š${response.statusText}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="status-error">âŒ è¿æ¥å¤±è´¥</span>\n\né”™è¯¯ä¿¡æ¯ï¼š\n${error.message}`;
      }
    }

    function clearResult() {
      document.getElementById('result').innerHTML = '';
    }
  </script>
</body>
</html>